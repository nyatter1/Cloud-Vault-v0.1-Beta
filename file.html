<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer | CloudVault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Code Highlighting Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        pre code { font-family: 'Fira Code', monospace !important; border-radius: 12px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="h-16 border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50 px-6 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='main.html'" class="w-10 h-10 rounded-xl hover:bg-slate-800 flex items-center justify-center transition">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h1 id="fileName" class="font-semibold text-sm">Loading file...</h1>
                <p id="fileMeta" class="text-[10px] text-slate-500 uppercase tracking-widest">---</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="downloadFile()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-xs font-bold transition flex items-center gap-2">
                <i class="fas fa-download"></i> Download
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <div id="viewerContent" class="flex-1 flex items-center justify-center p-6 overflow-auto">
            <!-- Content dynamically injected here -->
            <div id="loader" class="flex flex-col items-center gap-4">
                <div class="w-12 h-12 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin"></div>
                <span class="text-xs text-slate-500 font-medium">Preparing your file...</span>
            </div>
        </div>
    </main>

    <script>
        const file = JSON.parse(sessionStorage.getItem('current_file'));
        
        if (!file) {
            window.location.href = 'main.html';
        }

        window.onload = () => {
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileMeta').innerText = `${file.type || 'Unknown'} â€¢ ${formatSize(file.size)}`;
            renderContent();
        };

        function renderContent() {
            const container = document.getElementById('viewerContent');
            const type = file.type || '';
            const name = file.name.toLowerCase();
            const content = file.content;

            container.innerHTML = '';

            // 1. Image View
            if (type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = content;
                img.className = "max-w-full max-h-full rounded-lg shadow-2xl object-contain";
                container.appendChild(img);
            } 
            // 2. Video View
            else if (type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = content;
                video.controls = true;
                video.className = "max-w-full max-h-full rounded-lg shadow-2xl";
                container.appendChild(video);
            }
            // 3. Code / Text View
            else if (isCodeFile(name, type)) {
                const pre = document.createElement('pre');
                const code = document.createElement('code');
                
                // Set language class for highlight.js
                const ext = name.split('.').pop();
                code.className = `language-${getLangClass(ext)}`;
                code.textContent = content;
                
                pre.appendChild(code);
                pre.className = "w-full max-w-5xl h-fit";
                container.appendChild(pre);
                hljs.highlightElement(code);
            }
            // 4. Default Fallback
            else {
                container.innerHTML = `
                    <div class="text-center p-10 bg-slate-800/50 rounded-3xl border border-slate-700 max-w-sm">
                        <i class="fas fa-file-invoice text-5xl text-slate-600 mb-4"></i>
                        <h2 class="text-lg font-bold mb-2">Preview unavailable</h2>
                        <p class="text-sm text-slate-400 mb-6">We don't support online previews for this file type yet.</p>
                        <button onclick="downloadFile()" class="w-full py-3 bg-white text-slate-900 rounded-xl font-bold text-sm">Download to View</button>
                    </div>
                `;
            }
        }

        function isCodeFile(name, type) {
            const codeExts = ['.js', '.css', '.html', '.py', '.cs', '.cpp', '.java', '.json', '.txt', '.ts', '.php', '.sh'];
            return type.startsWith('text/') || codeExts.some(ext => name.endsWith(ext));
        }

        function getLangClass(ext) {
            const map = {
                'js': 'javascript',
                'py': 'python',
                'cs': 'csharp',
                'cpp': 'cpp',
                'ts': 'typescript',
                'html': 'xml',
                'css': 'css',
                'json': 'json'
            };
            return map[ext] || 'plaintext';
        }

        function formatSize(bytes) {
            if (!bytes) return '0 KB';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
        }

        window.downloadFile = () => {
            const link = document.createElement('a');
            link.href = file.content;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    </script>
</body>
</html>
